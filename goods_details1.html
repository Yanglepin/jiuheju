<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>九和居-商品详情</title>
		<script src="js/mui.min.js"></script>
		<link href="css/mui.css" rel="stylesheet" />
		<link rel="stylesheet" href="css/app.css" />
		<style>
			.mui-segmented-control.imgbox-list{
				min-height: 15rem;
			}
			.mui-segmented-control.details-tab .mui-control-item{
				width: 50%;
			}
			.mui-segmented-control.mui-segmented-control-inverted .mui-control-item.mui-active{
				color: #036342;
    			border-bottom: 2px solid #036342;
    			box-sizing: border-box;
			}
			.mui-segmented-control.mui-scroll-wrapper .mui-scroll{
				height: auto;
			}
			.mui-segmented-control.goods-slider{
				min-height: 16rem;
			}
			.act{
				border: 1px solid #036342 !important;
				color: #036342 !important;
			}
           .mui-segmented-control.mui-segmented-control-inverted{
				width: 100%;
				margin-bottom: 10px;
				border-bottom: 1px solid #F3F3F3; 
			}
		</style> 
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-icon mui-icon-left-nav mui-pull-left" onclick="mui.back()"></a>
			<h1 class="mui-title">商品详情</h1>
		</header>
		<div class="mui-content mui-scroll-wrapper">
			<div class="goods-details">
				<div id="goodsdetails">
					<!--<div class="goods-top">
						<img src="images/d1.png" />
					</div>
					<div class="goods-title mui-ellipsis-2">九和居 中式 侧吸式欧式抽油烟机燃气灶具套装 自动开合 20立方米大吸力</div>
					<div class="goods-bottom">
						<div class="goods-bottom-top mui-clearfix">
							<div class="hebin mui-pull-left">
								<div class="zen">
									<span style="color: #f0c16e;padding: 2% 3%;border: 1px solid #eba806;border-radius: 4px;">每人限购1件</span>
								</div>
							</div>
							<span class="mui-block mui-pull-right">已售: 24件</span>
						</div>
						<div class="goods-bottom-bom mui-clearfix">
							<img src="images/v2.png"  style="float: left;margin-top: -1%;"/>
							<span class="mui-block mui-pull-left" style="color: #333;font-size: 16px;">
								1590
							</span>
							<span class="mui-block mui-pull-left gray" style="margin-left: 2%;">￥1999</span>
							<span class="mui-block mui-pull-right">库存: 76件</span>
						</div>
					</div>-->
				</div>
				<div class="goods-service mui-clearfix">
					<div class="service-list mui-pull-left">服务: </div>
					<div class="service-list mui-pull-left qitian">七天退换</div>
					<div class="service-list mui-pull-left huanbao">环保保障</div>
					<div class="service-list mui-pull-left quanguo">全国包邮</div>
					<div class="service-list mui-pull-left shangmen">上门安装</div>
				</div>
				<div class="goods-spec">
					<div id="goods-spec">
						<!--<div class="spec-title">产品规格:</div>
						<div class="spec-btn">
							<span>中式机炫耀黑</span>
							<span>中式机炫耀黑</span>
							<span>中式机炫耀黑</span>
							<span>中式机</span>
							<span>中式机黑</span>
						</div>-->
					</div>
					<!--<div class="count mui-clearfix">
						<button type="button" class="mui-pull-left cut">-</button>
						<input type="number" value="1" id="count" class="mui-pull-left"/ >
						<button type="button" class="mui-pull-left add" >+</button>
					</div>-->
				</div>
				<div class="goods-colum">
					<div class="colum-box kefu">联系客服</div>
					<div class="colum-box shouye">返回首页</div>
				</div>
				<div class="goods-recommend">
					<div class="goods-recommendtit"><img src="images/d-title.png" /></div>
					<div class="mui-slider">
							<div id="sliderSegmentedControl" class="goods-slider mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
							<div class="mui-scroll" id="rightScroll">
								<!--<a class="imgbox-list" data-id="" data-url="">
									<div class="goods-imgbox"><img src="images/banner.png" /></div>
									<div class="goods-imgboxtit mui-text-left mui-ellipsis-2">连衣裙2019春季新品女装V领网纱沙滩针织长袖连衣裙子 杏色</div>
									<div class="red mui-text-left">￥740.00</div>
									<div class="gray mui-text-left">售出：87</div>
								</a>
								-->
								
							</div>
						</div>
					</div>
				</div>
			</div>
			<div style="min-height: 5px; background-color: #f5f5f5;"></div>
			<div id="sliderSegmentedControl" class="details-tab mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted" style="border-bottom: 2px solid #F3F3F3;">
					<a class="mui-control-item mui-active" href="#item0" data-status="0">商品详情</a>
					<a class="mui-control-item" href="#item1" data-status="1">商品评论</a>
			</div>
			<div class="mui-slider-group" id="segmentedControlContents">
				<div id="item0" class="mui-slider-item mui-control-content goods-list mui-clearfix mui-active">
					<!--<img src="images/banner.png" />-->
				</div>
				<div id="item1" class="mui-slider-item mui-control-content goods-list mui-clearfix ">
					<!--<div style="border-bottom: 5px solid #F3F3F3;">
						<div class="comment-title mui-clearfix">
							<div class="mui-pull-left">
								<img src="images/banner.png" />
								<span>路在远方</span>
							</div>
							<div class="mui-pull-right">
								2017-10-27 16:46
							</div>
						</div>
						<div class="comment-con">老板您好！机器收到了，很满意，跟实体店一样，价格很优惠了不少，谢谢！</div>
					</div>
					<div style="border-bottom: 5px solid #F3F3F3;">
						<div class="comment-title mui-clearfix">
							<div class="mui-pull-left">
								<img src="images/banner.png" />
								<span>路在远方</span>
							</div>
							<div class="mui-pull-right">
								2017-10-27 16:46
							</div>
						</div>
						<div class="comment-con">老板您好！机器收到了，很满意，跟实体店一样，价格很优惠了不少，谢谢！</div>
					</div>-->
					

				</div>
			</div>
			<div class="dibuan">
				<p class="shen1">
					<span>立即兑换</span>
				</p>
				<div style="clear: both;"></div>
			</div>
		</div>
		<input type="hidden" id="select_skuid" value="" />
		<input type="hidden" id="sku_id" value="" />
		<script type="text/javascript" src="js/jquery-3.3.1.min.js"></script>
		<script type="text/javascript" src="js/app.js"></script>
		<script type="text/javascript" charset="utf-8">
			mui.init();
			var imgUrl = app.getServerUrl() + '/';
			mui.plusReady(function() {
				//浏览赠送合币
				setTimeout(function(){
					getPoint();
				},5000);
				var self = plus.webview.currentWebview();
				goods_id = self.goods_id;
//				console.log(goods_id);
				//商品详情
				getGoodsDetails(goods_id);
				//精品推荐
				getRecommend();
				//商品评论
				getComments(goods_id);
				//返回首页
				mui('.goods-colum').on('tap', '.colum-box', function() {
					var id = this.getAttribute("data-id");
					var url = this.getAttribute("data-url");
					mui.openWindow({  
					   id: id,  
					   url: url,
					   waiting: {
							autoShow: true, //自动显示等待框，默认为true
							title: '正在加载...' //等待对话框上显示的提示内容
						}
					}); 
				})

			})
			//商品详情
			function getGoodsDetails(goods_id) {
				mui.ajax(app.getServerUrl() +'/index.php?s=/api/goods/getGoodsDetail&token='+localStorage.getItem('token'), {
					data: {
						goods_id: goods_id 
					},
					dataType: 'json', //服务器返回json格式数据
					type: 'post', //HTTP请求类型
					timeout: 10000, //超时时间设置为10秒；   
					success: function(data) {
//						console.log("商品详情："+JSON.stringify(data));    
						var html = '';
						html +='<div class="goods-top"><img src="' + imgUrl + data.img_temp_array[0].pic_cover + '" /></div>';
						html +='<div class="goods-title mui-ellipsis-2">'+data.goods_name+'</div>';
						html +='<div class="goods-bottom">';
						html +='<div class="goods-bottom-top mui-clearfix"><div class="hebin mui-pull-left">';
						html +='<div class="zen"><span style="color: #f0c16e;padding: 2% 3%;border: 1px solid #eba806;border-radius: 4px;">每人限购1件</span></div></div>';
						html+='<span class="mui-block mui-pull-right">已售: '+data.sales+'件</span>';
						html+='</div>';
						html+='<div class="goods-bottom-bom mui-clearfix">';
						html +='<img src="images/v2.png"  style="float: left;margin-top: -1%;"/>';
						html+='<span class="mui-block mui-pull-left" style="color: #333;font-size: 16px;" id="change_price">'+data.point_exchange+'</span>';
						html+='<span class="mui-block mui-pull-left gray">&yen;'+data.price+'</span>';
						html+='<span class="mui-block mui-pull-right">库存: '+data.stock+'件</span>';
						html+='</div></div>';
						$("#goodsdetails").html(html);
						
						//规格
						var spec = ''; 
//						console.log("商品规格："+JSON.stringify(data.spec_list));   
						mui.each(data.spec_list,function(index,item){
							spec+='<div class="spec-title">'+item.spec_name+':</div>';
							spec+='<div class="spec-btn">';
							mui.each(item.value,function(ix,it){
								spec+='<span data-index="'+index+'" data-specid="'+it.spec_id+":"+it.spec_value_id+'">'+it.spec_value_name+'</span>';
							}) 
							spec+='</div>';
						})
						$("#goods-spec").html(spec);  
						//点击选择规格
						var specObc = {};
						mui('.spec-btn').on('tap', 'span', function() {
							var select_string = '';
							var spec_id = this.getAttribute("data-specid"); 
							var index = this.getAttribute("data-index");
							specObc[index] = spec_id;
							
							for (var k in specObc) {   
						      if (k == 0) {
						        select_string += specObc[k];
						      } else {
						        select_string += ';' + specObc[k];
						      }
						      if(k==2){
						      	getChangePrice(select_string); //改变价格
						      }
						    }
							console.log(select_string);	
							$("#select_skuid").val(select_string);
							$(this).addClass("act");
							$(this).siblings('span').removeClass('act');  
						})
						
						//商品详情内容
						var goodsCon = '';
						mui.each(data.img_list,function(index,item){
							goodsCon +='<img src="' + imgUrl + item.pic_cover + '" />';
						})
						$("#item0").html(goodsCon);
						
						
						//立即兑换
						mui('.shen1').on('tap', 'span', function() {
							var sku_id = $("#sku_id").val();
							
							var goods_sku_list = sku_id+":"+1;
							console.log(goods_sku_list);
							var pay_money = data.point_exchange;
							mui.ajax(app.getServerUrl() +'/index.php?s=/api/order/pointExchangeOrderCreate&token='+localStorage.getItem('token'),{
								data:{
									goods_sku_list: goods_sku_list.toString(), 
									integral: data.point_exchange
								},
								dataType:'json',//服务器返回json格式数据
								type:'post',//HTTP请求类型
								timeout:10000,//超时时间设置为10秒；
								success:function(data){
									console.log("立即兑换："+JSON.stringify(data));  
									if(data.code>0){
										mui.openWindow({ 
											id: 'pay_order1',
											url: 'pay_order1.html',
											extras: { 
												out_trade_no: data.out_trade_no,
												pay_money: pay_money
											},
											waiting: {
												autoShow: true, //自动显示等待框，默认为true
												title: '正在加载...' //等待对话框上显示的提示内容
											}
										}) 
									}else{
										mui.toast(data.message);
										return false; 
									}
								},
								error:function(xhr,type,errorThrown){
									//mui.toast(type);
									console.log(errorThrown);
								}
							});
						})
						
					},
					error: function(xhr, type, errorThrown) {
						mui.toast(type);
						console.log(type);
					}
				});
			}
			//精品推荐
			function getRecommend(){ 
				mui.ajax(app.getServerUrl() + '/index.php?s=/api/index/recommendation&token='+localStorage.getItem('token'), {
					data: {
						page: 1,
						page_size: 10
					},
					dataType: 'json', //服务器返回json格式数据
					type: 'post', //HTTP请求类型
					timeout: 10000, //超时时间设置为10秒；
					success: function(data) {
//						console.log(JSON.stringify(data));   
						var html = '';
						mui.each(data.data,function(index, item) {
							html +='<a class="imgbox-list" data-goodsid="'+item.goods_id+'">';
							html +='<div class="goods-imgbox"><img src="' + imgUrl + item.pic_cover_small + '" /></div>';
							html +='<div class="goods-imgboxtit mui-text-left mui-ellipsis-2">'+item.goods_name+'</div>';
							html +='<div class="red mui-text-left">&yen;'+item.promotion_price+'</div>';
							html +='<div class="gray mui-text-left">售出：'+item.real_sales+'</div>';
							html +='</a>';
						})
						$("#rightScroll").html(html);    
						//商品详情
						mui('#rightScroll').on('tap', 'a', function() {
							console.log("00");
//							var goods_id = this.getAttribute("data-goodsid");
							mui.openWindow({
								id: 'goods_list',
								url: 'goods_list.html', 
								extras: { 
//									goods_id: goods_id
								},
								waiting: { 
									autoShow: true, //自动显示等待框，默认为true
									title: '正在加载...' //等待对话框上显示的提示内容
								}
							});
						});
						
					},
					error: function(xhr, type, errorThrown) {
						mui.toast(type);
						console.log(type);
					}
				});
			}
			//商品评论
			function getComments(goods_id){
				
				mui.ajax(app.getServerUrl() + '/index.php?s=/api/goods/getGoodsComments&token='+localStorage.getItem('token'), {
					data: {
						goods_id: goods_id
					},
					dataType: 'json', //服务器返回json格式数据
					type: 'post', //HTTP请求类型
					timeout: 10000, //超时时间设置为10秒；
					success: function(data) {
//						console.log(JSON.stringify(data));    
						var html = '';
						if(data.total_count==0){
							html +='<div style="text-align:center;font-size:1.5rem; height:5rem;line-height:5rem;">暂时还没有评论</div>';
						}else{
							mui.each(data.data,function(index, item) {
								html +='<div style="border-bottom: 5px solid #F3F3F3;">';
								html +='<div class="comment-title mui-clearfix">';
								html +='<div class="mui-pull-left">';
								html +='<img src="images/banner.png" /><span>路在远方</span></div>';
								html +='<div class="mui-pull-right">2017-10-27 16:46</div></div>';
								html +='<p class="comment-con">老板您好！机器收到了，很满意，跟实体店一样，价格很优惠了不少，谢谢！</p>';
								html +='</div>';
							})
						}
						$("#item1").html(html);
						
					},
					error: function(xhr, type, errorThrown) {
						mui.toast(type);
						console.log(type);
					}
				});
				
			}
			//改变价格
			function getChangePrice(sku_id){
				console.log(sku_id);
				mui.ajax(app.getServerUrl() + '/index.php?s=/api/order/orderInventory&token=' + localStorage.getItem('token'), {
					data: {
						sku_id: sku_id
					},
					dataType: 'json', //服务器返回json格式数据
					type: 'post', //HTTP请求类型
					timeout: 10000, //超时时间设置为10秒；   
					success: function(data) {
						console.log("改变价格:"+JSON.stringify(data)); 
						$("#sku_id").val(data.data.sku_id);
					},
					error:function(xhr,type,errorThrown){
						console.log(type);
						mui.toast(type);	
					}
				})
			}
			
		</script>
	</body>

</html>